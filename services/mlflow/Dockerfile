FROM python:3.10.4

ARG MLFLOW_POSTGRES_USER
ARG MLFLOW_POSTGRES_PASSWORD
ARG MLFLOW_POSTGRES_DB
ARG MLFLOW_S3_ENDPOINT_URL
ARG MINIO_BUCKET_NAME
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY

ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
ENV AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
ENV MLFLOW_S3_ENDPOINT_URL=${MLFLOW_S3_ENDPOINT_URL}
ENV MLFLOW_POSTGRES_URI="postgresql://${MLFLOW_POSTGRES_USER}:${MLFLOW_POSTGRES_PASSWORD}@mlflow_postgres:5432/${MLFLOW_POSTGRES_DB}"

# install mlflow
RUN pip3 install psycopg2-binary boto3 mlflow

ENTRYPOINT mlflow server --host "0.0.0.0" --port "4000" --backend-store-uri ${MLFLOW_POSTGRES_URI} --default-artifact-root "s3://${MINIO_BUCKET_NAME}" 